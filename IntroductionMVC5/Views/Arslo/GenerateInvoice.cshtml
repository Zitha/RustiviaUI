@model IntroductionMVC5.Models.ArsloTrading.ArsloInvoice

@{
    ViewBag.Title = "GenerateInvoice";
}
<script type="text/javascript">
    var i = 1;
    var invoiceItems = [];
    var profItems = 0;
    function calculatePriceTotal() {

        var object = {};
        var text = $("#selectDescription").find(":selected").text();
        for (var i = 0; i < invoiceItems.length; i++) {
            if (invoiceItems[i].Description == text) {
                object = invoiceItems[i];
                break;
            }
        }
        var counter=1* $("#itemCount").val();
        for (a = 0; a < counter; a++) {
            var itm = '#unitPrice' + a;

            var itmPrice = 1 * $(itm).val();
            var isitmPriceNumber = isNaN(itmPrice);

            if (isitmPriceNumber) {
                var replaceVal = $(itm).val().substr(0, $(itm).val().length - 1);
                $(itm).val(replaceVal);
                return;
            }

            var qty = '#quantity' + a;
            var qtyVal = 1 * $(qty).val();
            var isqtyValNumber = isNaN(qtyVal);
            if (isqtyValNumber) {
                var replaceVal = $(qty).val().substr(0, $(qty).val().length - 1);
                $(qty).val(replaceVal);
                return;
            }

            if (object.Quantity >= qtyVal) {
                if (itmPrice && qtyVal) {
                    var total = itmPrice * qtyVal;
                    $('#unitTotalPrice' + a).val(total.toFixed(2));
                }
            } else {
                $(qty).val(object.Quantity);
                var total = itmPrice * object.Quantity;
                $('#unitTotalPrice' + a).val(total.toFixed(2));
            }
        }
        $("#itemCount").val(profItems);
    }

    //function addNewColumn(profoma) {
    //    $("#tBodyBra").html('');

    //    var profomaLength = profoma.ProfomaItems.length;
    //    $("#itemCount").val(profomaLength);
    //    for (var d = 0; d < profomaLength; d++) {
    //        $('#tab_logic').append('<tr id="addr' + (d) + '"></tr>');
    //        $('#addr' + d).html("<td>" + (d + 1) + "</td>" +
    //            "<td><input id='description" + d + "'name='description" + d + "' type='text' value='" + profoma.ProfomaItems[d].Description + "' readonly placeholder='Item' class='form-control' /> </td >" +
    //            "<td><input id='quantity" + d + "' type='text' onkeyup='calculatePriceTotal()' placeholder='QTY' value='" + profoma.ProfomaItems[d].Quantity + "' name='quantity" + d + "' class='form-control'></td>" +
    //            "<td><input id='unitPrice" + d + "' name='unitPrice" + d + "' value='" + profoma.ProfomaItems[d].Price + "' readonly type='text' placeholder='Price' class='form-control'></td>" +
    //            "<td> <input class='form-control input-md' id='unitTotalPrice" + d + "' name='unitTotalPrice" + d + "' type='number' value='" + profoma.ProfomaItems[d].TotalPrice + "' readonly placeholder='Total Price' /></td > ");

    //        $('#tab_logic').append('<tr id="addr' + (d + 1) + '"></tr>');

    //        var qty = '#quantity' + d;
    //        var qtyVal = 1 * $(qty).val();

    //        originalQuantity.push(qtyVal);
    //    }
    //}

    function FillCity(profomaId) {

        $.ajax({
            url: '/Arslo/GetProfomaItems?profomaId=' + profomaId,
            type: "GET",
            dataType: "JSON",
            success: function (profoma) {
                invoiceItems = profoma.ProfomaItems;
                // addNewColumn(profoma);
                $('#selectDescription').find('option').remove().end();
                $('#selectDescription').append('<option value=""></option>');
                for (var i = 0; i < invoiceItems.length; i++) {
                    $('#selectDescription').append("'<option value=" + invoiceItems[i].Description + ">" + invoiceItems[i].Description + "</option>");
                }
          
                $('#selectQuntity').val('');
                $('#selectPrice').val('');
            }
        });
    }

    function doStuff() {
        var object = {};
        var text = $("#selectDescription").find(":selected").text();
        for (var i = 0; i < invoiceItems.length; i++) {
            if (invoiceItems[i].Description == text) {
                object = invoiceItems[i];
                break;
            }
        }

        $('#selectQuntity').val(object.Quantity);
        $('#selectPrice').val(object.Price);
    }

    $(document).ready(function () {

        var now = new Date();
        var month = (now.getMonth() + 1);
        var day = now.getDate();
        if (month < 10)
            month = "0" + month;
        if (day < 10)
            day = "0" + day;
        var today = now.getFullYear() + '/' + month + '/' + day;
        if (!$('#invoiceDate').val()) {
            $('#invoiceDate').val(today);
        }
        $('.datepicker').datepicker({
            autoclose: true,
            format: 'yyyy/mm/dd',
        }).on('changeDate', function (ev) {
            $('.datepicker').datepicker('hide');
        });

        //Profoma Rows Items
        $("#add_row").click(function () {
            var description =  $("#selectDescription").find(":selected").text();;
            var unitPrice = 1 * $('#selectPrice').val();
            var quntity = 0; 

            var aa = 1 * $("#itemCount").val();
            $('#addr' + aa).html("<td>" + (aa + 1) +
                "</td><td><input id='description" + aa + "'name='description" + aa + "' type='text' value='" + description + "' readonly placeholder='Item' class='form-control' /></td><td><input id='quantity" + aa + "' type='text' onkeyup='calculatePriceTotal()' placeholder='QTY' value='" + quntity + "' name='quantity" + aa + "' class='form-control'></td><td><input id='unitPrice" + aa + "' name='unitPrice" + aa+ "' value='" + unitPrice + "' readonly type='text' placeholder='Price' class='form-control'></td><td><input class='form-control input-md'id='unitTotalPrice" + aa + "' name='unitTotalPrice" + aa + "' type='number' readonly placeholder='Total Price'/></td>");


            $('#tab_logic').append('<tr id="addr' + (aa + 1) + '"></tr>');
            aa++;
            $("#itemCount").val(aa);
            profItems = aa;
            i = profItems;
        });

        $("#delete_row").click(function () {
            if (profItems > 1) {
                $("#addr" + (profItems - 1)).html('');
                profItems--;
                i = profItems;
                $("#itemCount").val(profItems);
            }
        });
    });
</script>
<h2>Generate Invoice</h2>
@using (Html.BeginForm("GenerateInvoice", "Arslo", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true)
    <fieldset>
        <div class="row">
            <div class="col-xs-2">
                <label style="margin-top:5%">Invoice Number</label>
            </div>
            <div class="col-xs-3">
                @Html.TextBoxFor(model => model.Reference, new { @class = "form-control", @type = "text", @readonly = "@readonly" })
                @Html.ValidationMessageFor(model => model.Reference)
            </div>
            <div class="col-xs-1 col-lg-offset-2">
                <label style="margin-top:8%">Date</label>
            </div>
            <div class="col-xs-3">
                @Html.TextBoxFor(model => model.Date, new { @class = "datepicker form-control", @name = "invoiceDate", @type = "text" })
                @Html.ValidationMessageFor(model => model.Date)
            </div>
        </div>
        <div class="row" style="margin-top:1%">
            <div class="col-xs-2">
                <label style="margin-top:5%">POL</label>
            </div>
            <div class="col-xs-3">
                @Html.TextBoxFor(model => model.PointOfLoading, new { @class = "form-control", @type = "text" })
                @Html.ValidationMessageFor(model => model.Reference)
            </div>
            <div class="col-xs-1 col-lg-offset-2">
                <label style="margin-top:8%">POD</label>
            </div>
            <div class="col-xs-3">
                @Html.TextBoxFor(model => model.PointOfDelivery, new { @class = "form-control", @type = "text" })
                @Html.ValidationMessageFor(model => model.Date)
            </div>
        </div>
        <div class="row" style="margin-top:1%">
            <div class="col-xs-2">
                <label style="margin-top:5%">Profoma</label>
            </div>
            <div class="col-xs-3">
                <div class="form-group">
                    @Html.DropDownList("Profoma.Id", (SelectList)ViewBag.Profomas, string.Empty, new { @class = "form-control", @onchange = "FillCity(this.value)" })
                </div>
            </div>
        </div>
        <div class="row" style="margin-top:1%" id="itemToAdd">
            <div class="col-xs-2">
                <label style="margin-top:8%">Invoice Item</label>
            </div>
            <div class="col-xs-7">
                <table class="table table-bordered table-hover">
                    <tbody>
                        <tr>
                            <td>
                                <select class='form-control' onchange='doStuff()' placeholder='Description' name='selectDescription' id='selectDescription'></select>
                            </td>
                            <td>
                                <input type="text" id='selectQuntity' readonly  placeholder='QTY' class="form-control" />
                            </td>
                            <td>
                                <input type="text" id='selectPrice'  readonly placeholder='Price' class="form-control calcClass" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-xs-3">
                <a id="add_row" class="btn btn-default btn-mini" style="border:1px solid; border-color:#94c523;margin-top:3%">Add Invoice Item</a>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <table class="table table-bordered table-hover" id="tab_logic" style="margin-top:2%">
                    <thead>
                        <tr>
                            <th class="text-center">

                            </th>
                            <th class="text-center">
                                Description
                            </th>
                            <th class="text-center">
                                Quantity
                            </th>
                            <th class="text-center">
                                Unit Price
                            </th>
                            <th class="text-center">
                                Total Price
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tBodyBra">
                        <tr id='addr0'>
                            <td>1</td>
                            <td>
                                <input type="text" id='description0' name="description0" placeholder='Item' class="form-control" />
                            </td>
                            <td>
                                <input type="text" id='quantity0' onchange='calculatePriceTotal()' name="quantity0" placeholder='QTY' class="form-control" />
                            </td>
                            <td>
                                <input type="text" id='unitPrice0' onchange='calculatePriceTotal()' name="unitPrice0" placeholder='Price' class="form-control calcClass" />
                            </td>
                            <td>
                                <input type="text" id='unitTotalPrice0' readonly name="unitTotalPrice0" placeholder='Total Price' class="form-control" />
                            </td>
                        </tr>
                        <tr id='addr1'></tr>
                    </tbody>
                </table>
                <div class="row">
                    <div class="col-md-12">
                        <input id="itemCount" hidden="hidden" name="itemCount" />
                        <a id='delete_row' class="pull-right btn-mini btn btn-default" style="border:1px solid; border-color:red;">Delete Row</a>
                        @*<a id="add_row" class="btn btn-default btn-mini pull-right" style="border:1px solid; border-color:#94c523; margin-right:1px;">Add Row</a>*@
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <input id="itemCount" hidden="hidden" name="itemCount" />
                    </div>
                </div>
            </div>
        </div>
        <p>
            <input type="button" class="btn btn-primary" onclick=" location.href='@Url.Action("Index", "Arslo")'" value="Back" />
            <button value="Create" class="btn btn-primary" onclick=" location.href='@Url.Action("GenerateInvoice", "Arslo")'">Create</button>
        </p>
    </fieldset>
}
